<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.80cad295b4aa08a2ccda.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects;color:#1d70b8}a:active,a:hover{outline-width:0;color:#003078}a:visited{color:#4c2c92}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}</style><meta name="generator" content="Gatsby 2.18.12"/><title data-react-helmet="true">Blog - Animation in React - Uber Eats | Lexanth</title><meta data-react-helmet="true" name="description" content="Home page for Alex Anthony&#x27;s GitHub/JS experiments"/><meta data-react-helmet="true" property="og:title" content="Blog - Animation in React - Uber Eats"/><meta data-react-helmet="true" property="og:description" content="Home page for Alex Anthony&#x27;s GitHub/JS experiments"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Alex Anthony"/><meta data-react-helmet="true" name="twitter:title" content="Blog - Animation in React - Uber Eats"/><meta data-react-helmet="true" name="twitter:description" content="Home page for Alex Anthony&#x27;s GitHub/JS experiments"/><link rel="icon" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#000"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link as="script" rel="preload" href="/webpack-runtime-b7198b120cb9f0183d9b.js"/><link as="script" rel="preload" href="/app-e164f43e39da1e5b73ec.js"/><link as="script" rel="preload" href="/styles-a01da1cbeb363e35def7.js"/><link as="script" rel="preload" href="/commons-f2e889339345a5492fed.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-c04dabcc1fc52865c103.js"/><link as="fetch" rel="preload" href="/page-data/blog/uber-eats/page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><style data-emotion-css="a5hdks">.css-a5hdks{margin-bottom:1.45rem;background-color:black;height:100px;}</style><header class="css-a5hdks ek4tvat0"><style data-emotion-css="12h6cau">.css-12h6cau{margin:0 auto;max-width:1200px;padding:1.45rem 1.0875rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-12h6cau > *{margin:0 1rem;}</style><nav class="css-12h6cau ek4tvat1"><h1><style data-emotion-css="7wrv5d">.css-7wrv5d{color:white;-webkit-text-decoration:none;text-decoration:none;}.css-7wrv5d:visited{color:white;}.css-7wrv5d.active{color:#6496eb;}</style><a class="css-7wrv5d ek4tvat2" href="/">Lexanth</a></h1><h3><a class="css-7wrv5d ek4tvat2" href="/">Projects</a></h3><h3><a class="css-7wrv5d ek4tvat2" href="/blog">Blog</a></h3></nav></header><style data-emotion-css="ar00y6">.css-ar00y6{margin:0 auto;max-width:1200px;padding:0 1.0875rem 1.45rem;padding-top:0;}</style><div class="css-ar00y6 e1qsw1o60"><main class="css-0 e1qsw1o61"><h2>Animation in React - Uber Eats</h2><p>20 May 2020</p><article><p>I tend to see a lot more care going into animations in native apps that web applications. For example, React Navigation comes with animation built in. Part of this is just an expectation thing - people expect the animations in the native experience. Part of it is also the variable platform that the web represents; there's a whole lot of different devices/browsers out there! This all just makes it more of a challenge!</p>
<p>It's particularly interesting when comparing the mobile and web apps from the same company. Depending on the company, there's a good chance these are developed by different teams, but at least the designers are probably communicating!</p>
<p><img src="/d7ad5e7571dc5d0bbdddd5596dcbba19/UberEats.gif" alt="Uber Eats App"></p>
<p><em>Another laggy gif...</em></p>
<p>The menu page for the Uber Eats native app has (had?) this collapsible header, with a section indicator underneath using this masking effect. On the web, they've got a slightly different collapsible header (it doesn't show the restaurant name, and no masking effect). Also the scroll indicator doesn't seem to work at all on Desktop Firefox, but it does on Chrome for Android. So can we do it? And what are the trade offs?</p>
<p>Once again, I was put onto this idea from <a href="https://www.youtube.com/watch?v=xutPT1oZL2M">Can it be done in React Native?</a>. I've taken some ideas from there, but the different native and web tools make the approaches diverge somewhat.</p>
<h2>Breaking down the animation</h2>
<p>From the animation, we can see three components.</p>
<ul>
<li>There's the collapsible header, transitioning between the restaurant details and hero image into the restaurant name and section tabs.</li>
<li>Then there's the section tabs themselves, with the current tab highlighted and becoming the left-most tab.</li>
<li>Finally, there is using the tab header to drive the actual scroll position of the rest of the menu.</li>
</ul>
<h2>Tools</h2>
<p>Another scroll-based animation, so we're going to be in JavaScript-land. This looks like another job for react-spring and react-use-gesture. It seems like it's going to be quite similar to the <a href="https://www.youtube.com/watch?v=XOYsWZ-4Zsg&#x26;t=3s">Spotify Scrolling Header</a>.</p>
<p>The way that the text in the tab bar can be cut off by the black overlay looks like masking again, so we should be able to do that by animating <code class="language-text">clipPath</code>. And it's approximately rectangular (with rounded corners), so we shouldn't need the <code class="language-text">url()</code> hack we used in <a href="/blog/liquid-swipe">LiquidSwipe</a>.</p>
<p>As ever, I use a starter based on <code class="language-text">create-react-app</code>, with my preferred dev tools (prettier...) and <code class="language-text">styled-components</code> for CSS.</p>
<h2>Basic Setup</h2>
<p>Our basic DOM structure is dictated by which bits move and which don't. While we can move elements around in response to scrolling, it's going to be more performant to let the browser do it. So elements that move with the scroll go in a container which can overflow, fixed elements (the tab bar) go outside the overflowing element.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> Content <span class="token operator">=</span> styled<span class="token punctuation">.</span>div<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  overflow-y: auto;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: #efefef;
</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> App<span class="token operator">:</span> React<span class="token punctuation">.</span><span class="token function-variable function">FC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>AppContainer<span class="token operator">></span>
      <span class="token operator">&lt;</span>GlobalStyle <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>FixedHeader <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>Content<span class="token operator">></span>
        <span class="token operator">&lt;</span>HeaderImage src<span class="token operator">=</span><span class="token punctuation">{</span>restaurant<span class="token punctuation">.</span>image<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>RestaurantDetails details<span class="token operator">=</span><span class="token punctuation">{</span>restaurant<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>Menu menu<span class="token operator">=</span><span class="token punctuation">{</span>menu<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Content<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>AppContainer<span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">FixedHeader</code>, <code class="language-text">HeaderImage</code>, <code class="language-text">RestaurantDetails</code> and <code class="language-text">Menu</code> are all pretty much just standard presentational components with a little styling. The only thing worth noting is that the <code class="language-text">HeaderImage</code> has padding beneath it, representing where the restaurant name should be. We only have the restaurant name itself in <code class="language-text">FixedHeader</code>, and we're going to move it into position in this gap.</p>
<h2>Collapsible Header</h2>
<p>The first thing we need to do is track the scroll position. This is going to be our classic <code class="language-text">useSpring</code> and <code class="language-text">react-use-gesture</code> combo:</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> y <span class="token punctuation">}</span><span class="token punctuation">,</span> setScrollPos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bind <span class="token operator">=</span> <span class="token function">useScroll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> xy <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setScrollPos</span><span class="token punctuation">(</span><span class="token punctuation">{</span> y<span class="token operator">:</span> xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> immediate<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token operator">&lt;</span>Content <span class="token punctuation">{</span><span class="token operator">...</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>HeaderImage src<span class="token operator">=</span><span class="token punctuation">{</span>restaurant<span class="token punctuation">.</span>image<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>RestaurantDetails details<span class="token operator">=</span><span class="token punctuation">{</span>restaurant<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>Menu menu<span class="token operator">=</span><span class="token punctuation">{</span>menu<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Content<span class="token operator">></span></code></pre></div>
<p>I've used <code class="language-text">immediate: true</code> to make the y value immediate rather than using spring physics - we want our scroll animation to be really snappy.</p>
<p>The first thing we want to do is put the restaurant name in the gap we left for it. We can pass <code class="language-text">y</code>, our scroll position, into the <code class="language-text">FixedHeader</code> and use that to calculate the position. When we're scrolled to the top, we want the restaurant name to be moved down by the height of the header image. When we've completely scrolled the header image off the screen, we want the restaurant name in its normal position, and as we continue scrolling past this we don't want it to move. So this is an interpolation on the scroll position, with a clamp to stop it going past the end.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> titlePosition <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  range<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">IMAGE_HEIGHT</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateY(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">IMAGE_HEIGHT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateY(0px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  extrapolate<span class="token operator">:</span> <span class="token string">'clamp'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token operator">&lt;</span>Title style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>transform<span class="token operator">:</span> titlePosition<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Title<span class="token operator">></span></code></pre></div>
<p>For every pixel we scroll down, we reduce the <code class="language-text">translateY</code> by a pixel. And as <code class="language-text">y</code> is updating immediately, it looks like the title is moving with the scroll. This is a bit different to the approach we used for Spotify, where we had the title twice, with one fading in and the other out as they went past eachother.</p>
<p>The next problem is that the section tabs should only be visible when we've scrolled past the header image. This is therefore another function of the scroll position, <code class="language-text">y</code>.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> tabHeaderOpacity <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  range<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">IMAGE_HEIGHT</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">IMAGE_HEIGHT</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  extrapolate<span class="token operator">:</span> <span class="token string">'clamp'</span> <span class="token comment">// No point in an opacity outside the range 0-1!</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token operator">&lt;</span>TabHeader style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span> tabHeaderOpacity<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre></div>
<p>This works, but the tab header just appears instantly as we scroll past, rather than fading in. We could give a wider input range for the interpolation, but that means we can stop scrolling with the tabs with an opacity between zero and 1.</p>
<p>The solution here is to create another animated value which just represents whether we have scrolled past the header, and allow it to use a spring to give a fade in/out.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> y <span class="token punctuation">}</span><span class="token punctuation">,</span> setScrollPos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> scrolledPastHeader <span class="token punctuation">}</span><span class="token punctuation">,</span> setScrolledPastHeader<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  scrolledPastHeader<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bind <span class="token operator">=</span> <span class="token function">useScroll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> xy <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setScrollPos</span><span class="token punctuation">(</span><span class="token punctuation">{</span> y<span class="token operator">:</span> xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> immediate<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">setScrolledPastHeader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scrolledPastHeader<span class="token operator">:</span> xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token constant">IMAGE_HEIGHT</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>We can now use <code class="language-text">scrolledPastHeader</code> directly as our opacity. It will spring from 0 to 1 gradually, but never rest anywhere in between.</p>
<p>We've now got the tabs fading in and out, let's make them actually work!</p>
<h2>Section scroll tracking</h2>
<p>Before we can think about highlighting the active tab, we need to start tracking the active tab. This is the last tab whose title we have already started to scroll past. So this is comparing the scroll position (which we're already listening to) to the positions of the section headers in the menu. To do the latter, we need to actually measure the elements as they're laid out, as the section heights vary with the menu and the screen size.</p>
<p>To do this, I'm going to use <code class="language-text">react-measure</code>. This adds an <code class="language-text">onResize</code> callback to a component, which we can use to report back the section offsets.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> MenuSection <span class="token operator">=</span> styled<span class="token punctuation">.</span>section<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  padding: 10px;
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> MeasuredSection <span class="token operator">=</span> <span class="token function">withContentRect</span><span class="token punctuation">(</span>
  <span class="token string">'offset'</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> measureRef<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>MenuSection ref<span class="token operator">=</span><span class="token punctuation">{</span>measureRef<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">Section</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onLayout<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span><span class="token operator">:</span> Props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>MeasuredSection onResize<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>offset<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onLayout</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token punctuation">}</span></code></pre></div>
<p>We can then collect the offsets from all of the sections in our top level component (<code class="language-text">App</code> here). We need to persist these, so we can put them in state or in a ref (refs are just holders for a reference, they don't have to be used for references to DOM elements).</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> tabScrollAnchors <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>menu<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleLayout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  tabScrollAnchors<span class="token punctuation">.</span>current<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> offset<span class="token punctuation">.</span>top
<span class="token punctuation">}</span></code></pre></div>
<p>We'd also need something to update the length of the array if the menu changes, but we can leave that for now in our simple example.</p>
<p>Next we want to calculate the active tab index from these anchors and the scroll position. We could do this with a loop or use <code class="language-text">reduce</code>.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">getActiveTabIndex</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">y<span class="token punctuation">,</span> tabScrollAnchors</span><span class="token punctuation">)</span> <span class="token operator">=></span> tabScrollAnchors<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> curr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> y <span class="token operator">+</span> <span class="token constant">MIN_HEADER_HEIGHT</span> <span class="token operator">+</span> <span class="token constant">SCROLL_OFFSET</span> <span class="token operator">>=</span> curr <span class="token operator">?</span> i <span class="token operator">:</span> acc
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></code></pre></div>
<p>If the scroll position (<code class="language-text">y</code>) is past the top of the current section, use that section's index. Otherwise, ignore this section. As long as we consider the sections in order, we get the last section that we've scrolled past. I've also added an allowance for the height of the collapsed header (<code class="language-text">MIN_HEADER_HEIGHT</code>) and an extra trial and error margin so that it changes slightly after the title is passed.</p>
<p>Alternatively, we could have done this by interpolating <code class="language-text">y</code> between the scroll anchors, with the indexes as the output.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> activeTabIndex <span class="token operator">=</span> y<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  range<span class="token operator">:</span> tabScrollAnchors<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">anchor</span> <span class="token operator">=></span> anchor <span class="token operator">-</span> <span class="token constant">MIN_HEADER_HEIGHT</span> <span class="token operator">-</span> <span class="token constant">SCROLL_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> tabScrollAnchors<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">)</span>
  extrapolate<span class="token operator">:</span> <span class="token string">'clamp'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>However, this would have restricted us to having <code class="language-text">activeTabIndex</code> be as springy as <code class="language-text">y</code>, which we wanted to be immediate. Using a separate animated value allows us more flexibility here.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> activeTabIndex <span class="token punctuation">}</span><span class="token punctuation">,</span> setActiveTabIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> activeTabIndex<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bind <span class="token operator">=</span> <span class="token function">useScroll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> xy <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setScrollPos</span><span class="token punctuation">(</span><span class="token punctuation">{</span> y<span class="token operator">:</span> xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> immediate<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">setScrolledPastHeader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scrolledPastHeader<span class="token operator">:</span> xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token constant">IMAGE_HEIGHT</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">setActiveTabIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> activeTabIndex<span class="token operator">:</span> <span class="token function">getActiveTabIndex</span><span class="token punctuation">(</span>xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tabScrollAnchors<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h2>Tab movement</h2>
<p>There are two aspects to the tab response to scrolling: the black active tab indicator resizes for the active tab title and the section titles themselves move so that the active one is left-most. Let's start with the movement.</p>
<p>This would be easy if our tabs were fixed width - we have the index, so just move them <code class="language-text">index * tab width</code> to the left. However, a quick look through some Uber Eats restaurants shows that the section titles sometimes get quite long. Instead, we can measure the widths of the section tabs and use that to move them - total all of the widths of tabs to the left of the active one.</p>
<p>For measuring the tabs, we can use the same technique as we used for measuring the offsets for the section headers in the menu.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> MeasuredTab <span class="token operator">=</span> <span class="token function">withContentRect</span><span class="token punctuation">(</span><span class="token string">'bounds'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> measureRef<span class="token punctuation">,</span> <span class="token operator">...</span>props<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>BaseTab ref<span class="token operator">=</span><span class="token punctuation">{</span>measureRef<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>BaseTab<span class="token operator">></span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">MeasurableTab</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onBoundsChange<span class="token punctuation">,</span> index <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>MeasuredTab onResize<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>bounds<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onBoundsChange</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> bounds<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token operator">...</span>
<span class="token keyword">const</span> tabWidths <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>menu<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleBoundsChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> bounds</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  tabWidths<span class="token punctuation">.</span>current<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> bounds<span class="token punctuation">.</span>width
<span class="token punctuation">}</span></code></pre></div>
<p>Next we want to use these tab widths, along with our active tab index animated value, to calculate the x offset.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> transform <span class="token operator">=</span> activeTabIndex<span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span><span class="token parameter">index</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateX(-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  tabWidths<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> curr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> index <span class="token operator">?</span> acc <span class="token operator">+</span> curr <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token constant">TAB_PADDING</span> <span class="token operator">:</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token operator">&lt;</span>TabsContainer style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> transform <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre></div>
<p>We could optimise this a bit (e.g. we don't need to calculate the cumulative widths every frame), but it's at least giving us the right animation.</p>
<h2>Tab highlighting</h2>
<p>This is the trickiest bit of the whole thing, and it's the bit that the Uber Eats web app doesn't do.</p>
<p>As mentioned before, it's clearly using masking to get the black tab indicator with white text to overlay the black text as it moves. To get the effect right as it moves, the white text actually needs to be moving at the same time as the black text. We therefore need to render two strips of tabs - one black text on white, one white text on black - and we'll clip the white on black one to only show for the active tab. We only need to measure one set of tabs, because we know they'll be the same size.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> OverlayTabsContainer <span class="token operator">=</span> <span class="token function">styled</span><span class="token punctuation">(</span>TabsContainer<span class="token punctuation">)</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  background-color: black;
  color: white;
</span><span class="token template-punctuation string">`</span></span>
<span class="token operator">...</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>TabsContainer style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> transform <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>menu<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>MeasurableTab
          key<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span>
          index<span class="token operator">=</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span>
          onBoundsChange<span class="token operator">=</span><span class="token punctuation">{</span>handleBoundsChange<span class="token punctuation">}</span>
        <span class="token operator">></span>
          <span class="token punctuation">{</span>name<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>MeasurableTab<span class="token operator">></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>TabsContainer<span class="token operator">></span>
    <span class="token operator">&lt;</span>OverlayTabsContainer style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> transform <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>menu<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>BaseTab key<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>name<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>MeasurableTab<span class="token operator">></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>OverlayTabsContainer<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>
<span class="token punctuation">)</span></code></pre></div>
<p>Now that we've got the black tab bar fixed over the white one (and both moving together), we can clip the black tab bar to just the active item. As a first pass, we can just set up a static style:</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> tabWidth <span class="token operator">=</span> <span class="token number">200</span>
<span class="token keyword">const</span> clipPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">inset(0 calc(100% - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tabWidth <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token constant">TAB_PADDING</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px) 0 0 round </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token constant">TAB_PADDING</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span>
<span class="token operator">...</span>
<span class="token operator">&lt;</span>OverlayTabsContainer style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> transform<span class="token punctuation">,</span> clipPath <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre></div>
<p>We have to use <code class="language-text">calc(100% - val)</code> as the values represent an inset from the edge of the whole container.</p>
<p>That looks about right for the first one, but obviously doesn't have the right tab width, and the clipped part moves off screen when we transform the tabs.</p>
<p>One solution to the latter is that we transform the tabs, rather than the tab container. This means doing slightly more work, so we only do it for the overlay tabs. Alternatively, we could nest another container and translate that; not sure which is going to be more performant. Another solution would be to calculate the clip path to allow for the transform - currently we just inset from the right, we could inset partially from the left and the right.</p>
<p>Getting the right tab width just needs some more interpolating on the active tab index animated value. This is good as it means that our tab indicator size and our tab movement will be synchronised.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> clipPath <span class="token operator">=</span> activeTabIndex
  <span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    range<span class="token operator">:</span> tabWidths<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">)</span>
    output<span class="token operator">:</span> tabWidths<span class="token punctuation">.</span>current
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">interpolate</span><span class="token punctuation">(</span><span class="token parameter">tabWidth</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> overlayWidth <span class="token operator">=</span> tabWidth <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token constant">TAB_PADDING</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">inset(0 calc(100% - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>overlayWidth<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px) 0 0 round </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token constant">TAB_PADDING</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>TabsContainer style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> transform <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>menu<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>MeasurableTab
          key<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span>
          index<span class="token operator">=</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span>
          onBoundsChange<span class="token operator">=</span><span class="token punctuation">{</span>handleBoundsChange<span class="token punctuation">}</span>
        <span class="token operator">></span>
          <span class="token punctuation">{</span>name<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>MeasurableTab<span class="token operator">></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>TabsContainer<span class="token operator">></span>
    <span class="token operator">&lt;</span>OverlayTabsContainer style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> clipPath <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>menu<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>BaseTab key<span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> transform <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">as</span><span class="token operator">=</span><span class="token punctuation">{</span>animated<span class="token punctuation">.</span>div<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>name<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>MeasurableTab<span class="token operator">></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>OverlayTabsContainer<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>
<span class="token punctuation">)</span></code></pre></div>
<p>Phew! The tab bar now responds nicely to scrolling. Now we just need to make the tabs clickable to drive the scroll!</p>
<h2>Clickable tabs</h2>
<p>When we click a section tab, we just need to scroll the content to bring that section into focus. Fortunately, we already know how far down each section is - we've got the <code class="language-text">tabScrollAnchors</code> saved off. We just need a ref to the content container to allow us to imperatively scroll it.</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> contentContainer <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleTabClick</span> <span class="token operator">=</span> <span class="token parameter">index</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>contentContainer<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    contentContainer<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      top<span class="token operator">:</span> tabScrollAnchors<span class="token punctuation">.</span>current<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token constant">MIN_HEADER_HEIGHT</span> <span class="token operator">-</span> <span class="token constant">SCROLL_OFFSET</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token operator">&lt;</span>Content <span class="token punctuation">{</span><span class="token operator">...</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>contentContainer<span class="token punctuation">}</span><span class="token operator">></span></code></pre></div>
<p>Everything else in the UI is already driven by the scroll position, so updating the scroll position should bring it back round.</p>
<h2>Cross browser testing</h2>
<p>On my laptop, that works great. On my phone (Nexus 5X), there's a lot of stuttering as the restaurant name moves. I switched this to render the restaurant name both in the scrollable and fixed headers, and just switch them (by opacity) as one went past the other.</p>
<p>In Chrome, the tab highlighting wasn't working too well. On investigation, it wasn't updating the interpolation config when the tabs reported their sizes, because updating refs doesn't force a re-render. I switched this to use state instead. Once this was sorted, it all seemed to work. There's the occasional bit of lag - it looks like this is pushing the mobile browser on my "top of the range-ish 4 years ago" phone towards the limit. The Android Uber Eats app doesn't use the masking, and it waits for the scrolling to be inactive to update the activeTabIndex.</p>
<h2>Putting it all together</h2>
<iframe
     src="https://codesandbox.io/embed/strange-noether-57n3p?fontsize=14&hidenavigation=1&module=%2Fsrc%2FApp.js&theme=light"
     style="width:100%; height:700px; border:0; border-radius: 4px; overflow:hidden;"
     title="strange-noether-57n3p"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<h2>Things we could change</h2>
<p>Rather than translating the tab bar off to the left, we could make it overflow and scroll it off to the left, with the overlay being driven by this scroll position.</p></article></main><footer>© Alex Anthony <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/uber-eats/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-e164f43e39da1e5b73ec.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-c04dabcc1fc52865c103.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a4c9ed25fcff807ab092.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-2c7eba38df802555a8d2.js"],"component---src-pages-index-js":["/component---src-pages-index-js-5f79f4ec9eead3d2b3b2.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-c04dabcc1fc52865c103.js" async=""></script><script src="/commons-f2e889339345a5492fed.js" async=""></script><script src="/styles-a01da1cbeb363e35def7.js" async=""></script><script src="/app-e164f43e39da1e5b73ec.js" async=""></script><script src="/webpack-runtime-b7198b120cb9f0183d9b.js" async=""></script></body></html>