{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/liquid-swipe/","result":{"data":{"blogPost":{"id":"45decb5e-1796-5f39-adb9-a108c3086a81","html":"<p>One of my favourite things to do to push my React skills and to try out new things is to try to reproduce bits of UI that I see on the internet, particularly animations. I find that a lot of React tutorials, particularly animation ones, cover basics, but not the bits that are used in real apps, so I like to share what I find!</p>\n<p><img src=\"/82179ee2b9bdc483e9ef866f8de18ddc/Liquidswipe3.gif\" alt=\"LiquidSwipe\"></p>\n<p><em>Quite glitchy slow gif of the end result - try for yourself at the bottom!</em></p>\n<p>I first saw this animation on the wonderful <a href=\"https://www.youtube.com/watch?v=gLopy2MCAqM\">Can it be done in React Native?</a> series on YouTube, but it was based on <a href=\"https://twitter.com/cuberto/status/1083060891657125889\">this concept from Cuberto</a>.</p>\n<p>What really interested me here was the smooth curve and the snapping. I could see how to do the text colour switching as the curve passed over it, from the <a href=\"https://www.youtube.com/watch?v=uH7am5ewY8M\">Chrome Tabs</a> example I've looked at before.</p>\n<p>Fortunately, <a href=\"https://github.com/Cuberto/liquid-swipe\">Cuberto made their version open source</a>. In addition, I could look at <a href=\"https://github.com/wcandillon/can-it-be-done-in-react-native/blob/master/season3/src/LiquidSwipe\">William Candillon's version from his YouTube channel</a>. Even so, it wasn't straightforward.</p>\n<h2>Tools</h2>\n<p>Getting the text colour to cut at the point where the curve crosses it is going to require the use of masking, like we used in <a href=\"https://www.youtube.com/watch?v=uH7am5ewY8M\">Chrome Tabs</a>. I remembered from reading documentation for that that the mask could be an SVG path, rather than just a box. Both Cuberto and wcandillon's versions use SVG paths to do create their curve shapes, so SVG seems to be the way to go. We know that SVG isn't the most performant, but it seems like we need its power here.</p>\n<p>The gesture is all based on dragging or clicking. We're going to be animating the SVG path in response to the drag/click state, so this needs to be in JavaScript-land (see previous posts). To avoid the DOM render loop, we'll use our favourite react-spring. Fortunately, this takes some API hints from the React Native Animated API, so we can reuse bits from wcandillon's React Native version. We can also use react-spring's companion library react-use-gesture to drive the springs.</p>\n<p>As ever, I use a starter based on <code class=\"language-text\">create-react-app</code>, with my preferred dev tools (prettier...) and <code class=\"language-text\">styled-components</code> for CSS.</p>\n<h2>Getting Started</h2>\n<p>To get the basic layout, we just two basic content pages, one on top of the other - we'll then show part of the top one based on the gesture state.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> ContentWrapper <span class=\"token operator\">=</span> styled<span class=\"token punctuation\">.</span>div<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  padding: 32px;\n  display: flex;\n  flex-direction: column;\n  user-select: none; /** So we don't accidentally select text while dragging */\n</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> Image <span class=\"token operator\">=</span> styled<span class=\"token punctuation\">.</span>img<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  height: 250px;\n  width: 250px;\n</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> Title <span class=\"token operator\">=</span> styled<span class=\"token punctuation\">.</span>h1<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> Description <span class=\"token operator\">=</span> styled<span class=\"token punctuation\">.</span>span<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">type</span> Props <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  image<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Content</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> image<span class=\"token punctuation\">,</span> title <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> Props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>ContentWrapper<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Image src<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>image<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Title<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>title<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Title<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Description<span class=\"token operator\">></span>\n      Lorem ipsum dolor sit amet<span class=\"token punctuation\">,</span> consectetur adipiscing elit<span class=\"token punctuation\">.</span> Donec rutrum\n      pharetra pellentesque<span class=\"token punctuation\">.</span> Donec blandit purus ut arcu vulputate<span class=\"token punctuation\">,</span> at rutrum\n      sem dictum<span class=\"token punctuation\">.</span> Mauris sagittis felis interdum arcu ultrices vestibulum<span class=\"token punctuation\">.</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Description<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ContentWrapper<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>I use the following CSS snippet a lot. It's equivalent to the React Native <code class=\"language-text\">absoluteFill</code> stylesheet.</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.absoluteFill</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> absolute<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">top</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">left</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">right</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">bottom</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we can put two of those on top of eachother in the App component:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> AppHeader <span class=\"token operator\">=</span> styled<span class=\"token punctuation\">.</span>header<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  background-color: #282c34;\n  min-height: 100vh;\n  display: flex;\n  flex-direction: column;\n  font-size: calc(10px + 2vmin);\n  color: white;\n  position: relative;\n</span><span class=\"token template-punctuation string\">`</span></span>\n\n<span class=\"token keyword\">const</span> Overlay <span class=\"token operator\">=</span> styled<span class=\"token punctuation\">.</span>div<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: aqua;\n  color: #282c34;\n</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>AppContainer<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>GlobalStyle <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>AppHeader<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>Content image<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>reactLogo<span class=\"token punctuation\">}</span> title<span class=\"token operator\">=</span><span class=\"token string\">\"React\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>Overlay<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>Content image<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>reduxLogo<span class=\"token punctuation\">}</span> title<span class=\"token operator\">=</span><span class=\"token string\">\"Redux\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Overlay<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>AppHeader<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>AppContainer<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We can now inspect and see that we have the two pages on top of eachother, with the \"Redux\" page on top having a different text and background colour - this represents the wave on top.</p>\n<h2>Start the Wave</h2>\n<p>For the Wave, we need to calculate an SVG path, then set that as the <code class=\"language-text\">clip-path</code> for the <code class=\"language-text\">Overlay</code> element (<a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/clip-path\">see MDN</a>). We showed in the Chrome Tabs example that we could use react spring to set the clip path as a style interpolated from an animated value, so we can do that again.</p>\n<p>To start off, we need a function to calculate our wave path based on our drag point. We also have different curves based on which direction we're going in. Fortunately, wcandillon <a href=\"https://github.com/wcandillon/can-it-be-done-in-react-native/blob/master/season3/src/LiquidSwipe/Weave.tsx\">already converted</a> Cuberto's Swift code to JavaScript, so with a few tweaks for just building a string, we can use most of it straight off. The code for these is in <code class=\"language-text\">waveHelpers.ts</code> and <code class=\"language-text\">wavePath.ts</code>. We also need a way of calculating out progress across the screen as a fraction. This is a standard interpolation of the cursor point (<code class=\"language-text\">x</code>) in the range of 0 to the viewport width, with different clamping for where the wave snaps across. This is in <code class=\"language-text\">progress.ts</code>.</p>\n<p>We need the viewport height and width as imports to the wave functions. Fortunately there are lots of libraries for doing this in React, we'll use <code class=\"language-text\">use-viewport-sizes</code> because it's nice and simple.</p>\n<p>We can wire these up with the initial resting value to validate that the wave is correct, and try a few other values to see its progress:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// Initial values - all the way to the right, halfway up</span>\n<span class=\"token keyword\">const</span> xy <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> isForward <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> xy<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> progress <span class=\"token operator\">=</span> <span class=\"token function\">calculateProgress</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> vpWidth<span class=\"token punctuation\">,</span> isForward<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> clipPath <span class=\"token operator\">=</span> <span class=\"token function\">buildWave</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  centerY<span class=\"token operator\">:</span> y<span class=\"token punctuation\">,</span>\n  horRadius<span class=\"token operator\">:</span> isForward\n    <span class=\"token operator\">?</span> <span class=\"token function\">calculateHorRadiusForwards</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">:</span> <span class=\"token function\">calculateHorRadiusBackwards</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  vertRadius<span class=\"token operator\">:</span> <span class=\"token function\">calculateVertRadius</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  sideWidth<span class=\"token operator\">:</span> <span class=\"token function\">calculateSideWidth</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  width<span class=\"token operator\">:</span> vpWidth<span class=\"token punctuation\">,</span>\n  height<span class=\"token operator\">:</span> vpHeight<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">...</span>\n\n<span class=\"token operator\">&lt;</span>Overlay style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> clipPath <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>Content image<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>reduxLogo<span class=\"token punctuation\">}</span> title<span class=\"token operator\">=</span><span class=\"token string\">\"Redux\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Overlay<span class=\"token operator\">></span></code></pre></div>\n<p>By fiddling with the <code class=\"language-text\">xy</code> and <code class=\"language-text\">isForward</code> values, I can see the wave for my finger being at different points, and with snapping from different sides (this was how I made sure that the wave calculation functions were correct).</p>\n<h2>Connecting up the drag</h2>\n<p>The <code class=\"language-text\">x</code> and <code class=\"language-text\">y</code> in the earlier examples are supposed to represent the user's finger/cursor position when dragging. To do this, we want them to be represented by animated values rather than numbers (this allows react-spring to skip the full React render/reconciliation cycle, which we don't want to do each frame).</p>\n<p>The documentation for <code class=\"language-text\">react-use-gesture</code> explains how to do this, along with many of the dragging examples on the react-spring website.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>props<span class=\"token punctuation\">,</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>xy<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bind <span class=\"token operator\">=</span> <span class=\"token function\">useDrag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> xy <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> xy <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> isForward <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> clipPath <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>xy<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> progress <span class=\"token operator\">=</span> <span class=\"token function\">calculateProgress</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> vpWidth<span class=\"token punctuation\">,</span> isForward<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> clipPath <span class=\"token operator\">=</span> <span class=\"token function\">buildWave</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    centerY<span class=\"token operator\">:</span> y<span class=\"token punctuation\">,</span>\n    horRadius<span class=\"token operator\">:</span> isForward\n      <span class=\"token operator\">?</span> <span class=\"token function\">calculateHorRadiusForwards</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> <span class=\"token function\">calculateHorRadiusBackwards</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    vertRadius<span class=\"token operator\">:</span> <span class=\"token function\">calculateVertRadius</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    sideWidth<span class=\"token operator\">:</span> <span class=\"token function\">calculateSideWidth</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    width<span class=\"token operator\">:</span> vpWidth<span class=\"token punctuation\">,</span>\n    height<span class=\"token operator\">:</span> vpHeight<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">...</span>\n\n<span class=\"token operator\">&lt;</span>AppHeader <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>Content image<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>reactLogo<span class=\"token punctuation\">}</span> title<span class=\"token operator\">=</span><span class=\"token string\">\"React\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>Overlay style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> clipPath <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>Content image<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>reduxLogo<span class=\"token punctuation\">}</span> title<span class=\"token operator\">=</span><span class=\"token string\">\"Redux\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Overlay<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>AppHeader<span class=\"token operator\">></span></code></pre></div>\n<p><code class=\"language-text\">props.xy</code> is a compound animated value of the x and y positions (rather than numbers), so instead of directly using them, we need to use the interpolate functionality. The returned <code class=\"language-text\">clipPath</code> is not an actual string, it's an animated value itself, so we need Overlay to be a <code class=\"language-text\">styled(animated.div)</code> rather than just a <code class=\"language-text\">styled.div</code>.</p>\n<p>As we drag around, we can now see that the curve moves with us. However, when we release, it doesn't snap to either side. We're also missing the button to manually switch from one side to another.</p>\n<h2>Get Snappy</h2>\n<p>The React Native version used the <code class=\"language-text\">snapPoint</code> helper from <code class=\"language-text\">react-native-redash</code> to choose where to snap to. Fortunately, it's about <a href=\"https://github.com/wcandillon/react-native-redash/blob/a9a614bd75b30225b15bf6935fe9bc1e93e2e000/packages/core/src/Animations.ts#L113\">15 lines of JavaScript</a>, so we can borrow that.</p>\n<p>The inputs to this function are a current position, a velocity in that axis, and the snap points to go between. We already have the current position (<code class=\"language-text\">x</code>) and <code class=\"language-text\">useDrag</code> can also provide us with the velocity. The snap points are 0 and the width of the viewport. We only want to snap when we're not actually dragging, which <code class=\"language-text\">useDrag</code> can also provide with the <code class=\"language-text\">active</code> flag.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> bind <span class=\"token operator\">=</span> <span class=\"token function\">useDrag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> xy<span class=\"token punctuation\">,</span> vxvy<span class=\"token punctuation\">,</span> active <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> xy <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> snapPoint <span class=\"token operator\">=</span> <span class=\"token function\">chooseSnapPoint</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> vxvy<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> vpWidth<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> xy<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>snapPoint<span class=\"token punctuation\">,</span> xy<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>At this point, we also want to be able to start toggling the direction. I'm going to handle this as a number rather than a boolean, partly to keep this version of react-spring's type definitions happier, partly because it would allow the further extension to more than 2 pages.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>props<span class=\"token punctuation\">,</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  xy<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  isForward<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> bind <span class=\"token operator\">=</span> <span class=\"token function\">useDrag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> xy<span class=\"token punctuation\">,</span> vxvy<span class=\"token punctuation\">,</span> active <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      xy<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> snapPoint <span class=\"token operator\">=</span> <span class=\"token function\">chooseSnapPoint</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> vxvy<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> vpWidth<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      xy<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>snapPoint<span class=\"token punctuation\">,</span> xy<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      isForward<span class=\"token operator\">:</span> snapPoint <span class=\"token operator\">/</span> vpWidth<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">...</span>\n\n<span class=\"token keyword\">const</span> clipPath <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>xy<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> isForward <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>isForward<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0.5</span>\n  <span class=\"token keyword\">const</span> progress <span class=\"token operator\">=</span> <span class=\"token function\">calculateProgress</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> vpWidth<span class=\"token punctuation\">,</span> isForward<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> clipPath <span class=\"token operator\">=</span> <span class=\"token function\">buildWave</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    centerY<span class=\"token operator\">:</span> y<span class=\"token punctuation\">,</span>\n    horRadius<span class=\"token operator\">:</span> isForward\n      <span class=\"token operator\">?</span> <span class=\"token function\">calculateHorRadiusForwards</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> <span class=\"token function\">calculateHorRadiusBackwards</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    vertRadius<span class=\"token operator\">:</span> <span class=\"token function\">calculateVertRadius</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    sideWidth<span class=\"token operator\">:</span> <span class=\"token function\">calculateSideWidth</span><span class=\"token punctuation\">(</span>vpWidth<span class=\"token punctuation\">,</span> vpHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    width<span class=\"token operator\">:</span> vpWidth<span class=\"token punctuation\">,</span>\n    height<span class=\"token operator\">:</span> vpHeight<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>With that, we're most of the way there! Our wave now moves with our finder and snaps to either side.</p>\n<h2>Button</h2>\n<p>If we look at the motion of the button, it doesn't precisely follow the wave; it follows the drag slightly independently of the wave. This is good news! It means we don't need to make any changes to wave for the button. The button also fades out as it moves across, and clicking it automatically snaps it.</p>\n<p>The position of the button is just a function of the drag position and the viewport width. The opacity is just a function of the <code class=\"language-text\">x</code> drag position and the viewport width. That means we can just use the existing <code class=\"language-text\">props.xy</code> animated value and do more interpolating!</p>\n<p>To animate the button smoothly, we just want to be animating easy to animate properties - <code class=\"language-text\">transform</code> and <code class=\"language-text\">opacity</code>. So the button uses <code class=\"language-text\">position: absolute</code> and the transform dictates its position. The <code class=\"language-text\">y</code> position of the button is simple - it follows the y drag position, with just an offset for the button size to get it centred.</p>\n<p>The <code class=\"language-text\">x</code> position of the button is more complicated. When the finger/cursor is all the way to the right, it should be a bit off the right edge of the viewport. Towards the left, it fades out, but in general it gets close to the finger/cursor. This is therefore an interpolation inside the interpolate - fortunately we have a quick interpolation function to hand. Based on some trial and error, we get:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> transform <span class=\"token operator\">=</span> xy<span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">translate3d(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span>\n    x<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">0.5</span> <span class=\"token operator\">*</span> vpWidth<span class=\"token punctuation\">,</span> vpWidth<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">0.5</span> <span class=\"token operator\">*</span> vpWidth<span class=\"token punctuation\">,</span> vpWidth <span class=\"token operator\">-</span> <span class=\"token constant\">BUTTON_SIZE</span> <span class=\"token operator\">-</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px, </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>y <span class=\"token operator\">-</span> <span class=\"token constant\">BUTTON_SIZE</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px, 0)</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>For the opacity, again we're just interpolating the finger/cursor <code class=\"language-text\">x</code> position, based on <code class=\"language-text\">vpWidth</code>. We also know it fades out before it hits the <code class=\"language-text\">0.5 * vpWidth</code> stop we included in the transform. A bit more trial and error gives:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> opacity <span class=\"token operator\">=</span> xy\n  <span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> x<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">interpolate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    range<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0.7</span> <span class=\"token operator\">*</span> vpWidth<span class=\"token punctuation\">,</span> vpWidth<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    output<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Put these together in a <code class=\"language-text\">style</code> prop for an <code class=\"language-text\">animated.button</code>, and we've got a button to follow our finger.</p>\n<p>The click handler is going to be very similar to the drag handler when the drag finishes. However, it's even simpler, as we can only snap in one direction with the button. We can keep the most recent <code class=\"language-text\">y</code> value by using the current value in our <code class=\"language-text\">set</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleButtonClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> xy<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">.</span>xy<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> isForward<span class=\"token operator\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Browser testing</h2>\n<p>This all now works great in Firefox. But we really want to check how mobile devices handle the animation, whether or not the wave nicely follows a dragging finger. I fired it up in Chrome on my Nexus 5X and... nothing. The animation doesn't work at all. Cue a lot of head scratching and looking into how to debug mobile Chrome.</p>\n<p>I then gave it a go in Chrome on my laptop, and still no dice. A <a href=\"https://caniuse.com/#feat=css-clip-path\">quick look on CanIUse</a> (and actually the bottom of the MDN docs about clip path) shows that Chrome doesn't support masking by a path supplied in a style tag or CSS. Actually, only Firefox really does. Fortunately, there's a workaround - the <code class=\"language-text\">url()</code> syntax. Combine that with some vendor prefixing (which styled-components does for us) and we can reach 94% of users. Close enough for this (in a real product we'd need to find a decent failure mode).</p>\n<p>So rather than setting the clipPath on the <code class=\"language-text\">Overlay</code>, we set it as a definition in an SVG and refer to it by id.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> Overlay <span class=\"token operator\">=</span> styled<span class=\"token punctuation\">.</span>div<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: aqua;\n  color: #282c34;\n  clip-path: url(#overlay);\n</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token operator\">...</span>\n\n<span class=\"token operator\">&lt;</span>svg height<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> width<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> position<span class=\"token operator\">:</span> <span class=\"token string\">'absolute'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>defs<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>clipPath id<span class=\"token operator\">=</span><span class=\"token string\">\"overlay\"</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>animated<span class=\"token punctuation\">.</span>path d<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>clipPath<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>clipPath<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>defs<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>svg<span class=\"token operator\">></span></code></pre></div>\n<p>Anything within the <code class=\"language-text\">defs</code> section of an SVG is just a definition for use by reference by other elements. If we wanted multiple of these sort of animations in our app, we could be using something to generate unique IDs for the path.</p>\n<p>With this change, it works on desktop Chrome. It <em>sort of</em> works in mobile chrome, but the URL bar which appears and disappears as you drag makes it imperfect. We can disable that with the <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/touch-action\"><code class=\"language-text\">touch-action</code></a> CSS property (props to <a href=\"https://alex.holachek.com/\">Alex Holachek</a> for this). This actually has a massive impact on mobile performance, because we're no longer resizing the viewport as we drag, so we don't go through the React render/reconciliation loop. We could also tidy it up by making it immediate rather than springy when the drag is active; this is more of a personal taste thing.</p>\n<h2>Finished product</h2>\n<p>I'm really happy with how this has come out. On my Nexus 5X, this is now really smooth. I might dig out my original Nexus 5 and see if it's still smooth there.</p>\n<p>The code is here on CodeSandbox - try it out!\n<em>It's better when you actually open it, rather than in an iframe within an iframe...</em></p>\n<iframe\n     src=\"https://codesandbox.io/embed/busy-murdock-oex5z?fontsize=14&hidenavigation=0&module=%2Fsrc%2FApp.js&theme=light\"\n     style=\"width:100%; height:700px; border:0; border-radius: 4px; overflow:hidden;\"\n     title=\"busy-murdock-oex5z\"\n     allow=\"accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking\"\n     sandbox=\"allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts\"\n   ></iframe>","frontmatter":{"title":"Animation in React - LiquidSwipe","date":"19 May 2020"},"fields":{"slug":"/blog/liquid-swipe/"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/liquid-swipe/"}}}